<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.manage.dao.custom.AccountSubTradeCuMapper">
    <!--交易记录 -->
    <select id="getTradeRecordList" resultType="map">
        SELECT * FROM
        (

        <!--支出 -->
        <if test="income==null or income==false">


            SELECT
            account_sub_trade_id,
            account_sub_trade_bank_no,
            account_sub_trade_create_time,
            account_sub_trade_tran_date,
            _from.account_sub_relation_id_type,
            _from.account_sub_no, /*发起账户*/
            _to.account_sub_no as account_sub_no_to, /*目标账户*/
            account_sub_trade_type, /*交易类型*/
            _to.account_sub_name, /*交易对象*/
            account_sub_trade_no, /*流水号*/
            account_sub_trade_tran_amt, /*交易金额*/
            account_sub_trade_tran_fee, /*手续费*/
            account_sub_trade_tran_payment_type, /*转入转出*/
            account_sub_trade_tran_status, /*交易状态*/
            account_sub_trade_take_cash_account_no, /*收款账户*/
            account_sub_trade_take_cash_account_name, /*收款账户*/
            account_sub_trade_ccy, /*币种*/
            account_sub_trade_remark, /*备注*/
            business_trade_business_type, /*业务类型*/
            business_trade_business_no, /*业务单号*/
            business_trade_business_content,
            business_trade_business_from, /*来源*/
            account_type,
            account_sub_trade_back_reason


            FROM account_sub_trade
            LEFT JOIN account_sub _from ON _from.account_sub_id = account_sub_trade.account_sub_trade_account_sub_id
            LEFT JOIN account ON _from.account_sub_account_id=account.account_id
            LEFT JOIN account_sub _to ON _to.account_sub_id = account_sub_trade.account_sub_trade_in_account_sub_id
            LEFT JOIN business_trade ON
            business_trade.business_trade_account_sub_trade_id=account_sub_trade.account_sub_trade_id
            <where>
                account_sub_trade_tran_status >= 0 and account_sub_trade_tran_status not in (7,9)
                <choose>
                    <when test="no!=null and no !=''">
                        and _from.account_sub_no=#{no}
                    </when>
                    <otherwise>
                        <if test="nos!=null and nos.size>0">
                            and _from.account_sub_no IN
                            <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
                                #{item}
                            </foreach>
                        </if>
                    </otherwise>
                </choose>

                <if test="startTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ >= ]]> #{startTime}
                </if>
                <if test="endTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ <= ]]> DATE_ADD(#{endTime},INTERVAL 1
                    DAY)
                </if>
                <if test="startAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ >= ]]> #{startAmt}
                </if>
                <if test="endAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ <= ]]> #{endAmt}
                </if>
                <if test="tradeType != null">
                    <if test="tradeType == 3">
                        and account_sub_trade.account_sub_trade_type in (3,7)
                    </if>
                    <if test="tradeType != 3">
                        and account_sub_trade.account_sub_trade_type = #{tradeType}
                    </if>
                </if>
                <if test="tradeStatus != null">
                    <if test="tradeStatus == 0">
                        and account_sub_trade.account_sub_trade_tran_status  in (0,7)
                    </if>
                    <if test="tradeStatus != 0">
                        and account_sub_trade.account_sub_trade_tran_status = #{tradeStatus}
                    </if>
                </if>
                <if test="businessType!=null and businessType!=''">
                    and business_trade_business_type=#{businessType}
                </if>
                <if test="source!=null and source!=''">
                    and business_trade_business_from=#{source}
                </if>
                <if test="status!=null and status!=''">
                    and account_sub_trade_tran_status=#{status}
                </if>
                <if test="accountType!=null and accountType!=''">
                    and account_Type=#{accountType}
                </if>
                <if test="accountName!=null and accountName!=''">
                    and POSITION(#{accountName} IN _to.account_sub_name)
                </if>
                <if test='keyword !=null and keyword !=""'>
                    AND (
                    POSITION(#{keyword} IN account_sub_trade_no) OR
                    POSITION(#{keyword} IN business_trade_business_no) OR
                    POSITION(#{keyword} IN account_sub_trade_tran_amt) OR
                    POSITION(#{keyword} IN account_sub_trade_remark) OR
                    POSITION(#{keyword} IN account_sub_trade_take_cash_account_no) OR
                    POSITION(#{keyword} IN _to.account_sub_name) OR
                    POSITION(#{keyword} IN business_trade_business_content)
                    )
                </if>
            </where>
        </if>
        <if test="income==null">
            UNION ALL
        </if>
        <!--收入 -->
        <if test="income==null or income==true">

            SELECT
            account_sub_trade_id,
            account_sub_trade_bank_no,
            account_sub_trade_create_time,
            account_sub_trade_tran_date,
            _from.account_sub_relation_id_type,
            _from.account_sub_no, /*发起账户*/
            _to.account_sub_no as account_sub_no_to, /*目标账户*/
            account_sub_trade_type, /*交易类型*/
            _from.account_sub_name account_sub_name, /*交易对象*/
            account_sub_trade_no, /*流水号*/
            account_sub_trade_tran_amt, /*交易金额*/
            account_sub_trade_tran_fee, /*手续费*/
            account_sub_trade_tran_payment_type, /*转入转出*/
            account_sub_trade_tran_status, /*交易状态*/
            account_sub_trade_take_cash_account_no, /*收款账户*/
            account_sub_trade_take_cash_account_name, /*收款账户*/
            account_sub_trade_ccy, /*币种*/
            account_sub_trade_remark, /*备注*/
            business_trade_business_type, /*业务类型*/
            business_trade_business_no, /*业务单号*/
            business_trade_business_content,
            business_trade_business_from, /*来源*/
            account_type,
            account_sub_trade_back_reason


            FROM account_sub_trade
            LEFT JOIN account_sub _from ON _from.account_sub_id = account_sub_trade.account_sub_trade_account_sub_id
            LEFT JOIN account ON _from.account_sub_account_id=account.account_id
            LEFT JOIN account_sub _to ON _to.account_sub_id = account_sub_trade.account_sub_trade_in_account_sub_id
            LEFT JOIN business_trade ON
            business_trade.business_trade_account_sub_trade_id=account_sub_trade.account_sub_trade_id
            <where>
                account_sub_trade_tran_status >= 0 and account_sub_trade_tran_status not in (7,9)
                <choose>
                    <when test="no!=null and no !=''">
                        and _to.account_sub_no=#{no}
                    </when>
                    <otherwise>
                        <if test="nos!=null and nos.size>0">
                            and _to.account_sub_no IN
                            <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
                                #{item}
                            </foreach>
                        </if>
                    </otherwise>
                </choose>

                <if test="startTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ >= ]]> #{startTime}
                </if>
                <if test="endTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ <= ]]> DATE_ADD(#{endTime},INTERVAL 1
                    DAY)
                </if>
                <if test="startAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ >= ]]> #{startAmt}
                </if>
                <if test="endAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ <= ]]> #{endAmt}
                </if>
                <if test="tradeType != null">
                    and account_sub_trade.account_sub_trade_type = #{tradeType}
                </if>
                <if test="tradeStatus != null">
                    and account_sub_trade.account_sub_trade_tran_status = #{tradeStatus}
                </if>
                <if test="businessType!=null and businessType!=''">
                    and business_trade_business_type=#{businessType}
                </if>
                <if test="source!=null and source!=''">
                    and business_trade_business_from=#{source}
                </if>
                <if test="status!=null and status!=''">
                    and account_sub_trade_tran_status=#{status}
                </if>
                <if test="accountType!=null and accountType!=''">
                    and account_Type=#{accountType}
                </if>
                <if test="accountName!=null and accountName!=''">
                    and POSITION(#{accountName} IN _from.account_sub_name)
                </if>
                <if test='keyword !=null and keyword !=""'>
                    AND (
                    POSITION(#{keyword} IN account_sub_trade_no) OR
                    POSITION(#{keyword} IN business_trade_business_no) OR
                    POSITION(#{keyword} IN account_sub_trade_tran_amt) OR
                    POSITION(#{keyword} IN account_sub_trade_remark) OR
                    POSITION(#{keyword} IN account_sub_trade_take_cash_account_no) OR
                    POSITION(#{keyword} IN _from.account_sub_name) OR
                    POSITION(#{keyword} IN business_trade_business_content)
                    )
                </if>
            </where>
        </if>
        ) t
        order by account_sub_trade_create_time desc
    </select>

    <!--交易记录  后台使用 -->
    <select id="getTradeRecordListAdmin" resultType="map">
        SELECT * FROM
        (

        <!--支出 -->
        <if test="income==null or income==false">


            SELECT
            account_sub_trade_id,
            account_sub_trade_bank_no,
            account_sub_trade_create_time,
            account_sub_trade_tran_date,
            _from.account_sub_relation_id_type,
            _from.account_sub_name,
            _from.account_sub_no, /*发起账户*/
            _to.account_sub_no as account_sub_no_to, /*目标账户*/
            _to.account_sub_name as account_sub_name_to, /*交易对象*/
            account_sub_trade_type, /*交易类型*/
            account_sub_trade_no, /*流水号*/
            CASE
            WHEN (account_sub_trade.account_sub_trade_in_account_sub_id  is not null and account_sub_trade.account_sub_trade_in_account_sub_id  != '') THEN
            concat( '-', account_sub_trade_tran_amt )
            else account_sub_trade_tran_amt
            END AS account_sub_trade_tran_amt ,/*交易金额*/
            account_sub_trade_tran_fee, /*手续费*/
            account_sub_trade_tran_payment_type, /*转入转出*/
            account_sub_trade_tran_status, /*交易状态*/
            account_sub_trade_take_cash_account_no, /*收款账户*/
            account_sub_trade_take_cash_account_name, /*收款账户*/
            account_sub_trade_ccy, /*币种*/
            account_sub_trade_remark, /*备注*/
            d2.dict_value as business_trade_business_typeC, /*业务类型*/
            business_trade_business_no, /*业务单号*/
            business_trade_business_content,
            d1.dict_value as business_trade_business_fromC, /*来源*/
            account_type,
            account_sub_trade_back_reason

            FROM account_sub_trade
            LEFT JOIN account_sub _from ON _from.account_sub_id = account_sub_trade.account_sub_trade_account_sub_id
            LEFT JOIN account ON _from.account_sub_account_id=account.account_id
            LEFT JOIN account_sub _to ON _to.account_sub_id = account_sub_trade.account_sub_trade_in_account_sub_id
            LEFT JOIN business_trade ON
            business_trade.business_trade_account_sub_trade_id=account_sub_trade.account_sub_trade_id
            LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务来源') d1 on d1.dict_key = business_trade_business_from
            LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务类型') d2 on d2.dict_key = business_trade_business_type

            <where>
                case
                    when business_trade_id is not null then  ( business_trade_is_delete = 0 and business_trade_status != 1)
                    when business_trade_id is null then ( 1=1)
                end
                and account_sub_trade_tran_status >= 0 and account_sub_trade_tran_status not in (7,9)

                and  account_sub_trade_account_sub_id is not null and account_sub_trade_account_sub_id != ''
                <if test="startTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ >= ]]> #{startTime}
                </if>
                <if test="endTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ <= ]]> DATE_ADD(#{endTime},INTERVAL 1
                    DAY)
                </if>
                <if test="startAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ >= ]]> #{startAmt}
                </if>
                <if test="endAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ <= ]]> #{endAmt}
                </if>
                <if test="tradeType != null">
                    <if test="tradeType == 3">
                        and account_sub_trade.account_sub_trade_type in (3,7)
                    </if>
                    <if test="tradeType != 3">
                        and account_sub_trade.account_sub_trade_type = #{tradeType}
                    </if>
                </if>
                <if test="tradeStatus != null">
                    <if test="tradeStatus == 0">
                        and account_sub_trade.account_sub_trade_tran_status  in (0,7)
                    </if>
                    <if test="tradeStatus != 0">
                        and account_sub_trade.account_sub_trade_tran_status = #{tradeStatus}
                    </if>
                </if>
                <if test="businessType!=null and businessType!=''">
                    and business_trade_business_type=#{businessType}
                </if>
                <if test="source!=null and source!=''">
                    and business_trade_business_from=#{source}
                </if>
                <if test="status!=null and status!=''">
                    and account_sub_trade_tran_status=#{status}
                </if>
                <if test="accountType!=null and accountType!=''">
                    and account_Type=#{accountType}
                </if>
                <if test="accountName!=null and accountName!=''">
                    and POSITION(#{accountName} IN _to.account_sub_name)
                </if>
                <if test='keyword !=null and keyword !=""'>
                    AND (
                    POSITION(#{keyword} IN account_sub_trade_no) OR
                    POSITION(#{keyword} IN business_trade_business_no) OR
                    POSITION(#{keyword} IN account_sub_trade_tran_amt) OR
                    POSITION(#{keyword} IN account_sub_trade_remark) OR
                    POSITION(#{keyword} IN account_sub_trade_take_cash_account_no) OR
                    POSITION(#{keyword} IN _to.account_sub_name) OR
                    POSITION(#{keyword} IN business_trade_business_content)
                    )
                </if>
            </where>
        </if>
        <if test="income==null">
            UNION ALL
        </if>
        <!--收入 -->
        <if test="income==null or income==true">

            SELECT
        account_sub_trade_id,
        account_sub_trade_bank_no,
        account_sub_trade_create_time,
        account_sub_trade_tran_date,
        _from.account_sub_relation_id_type,
        _from.account_sub_name, /*子账户名称*/
        _from.account_sub_no, /*账户编号*/
        _to.account_sub_no as account_sub_no_to, /*交易对象*/
        _to.account_sub_name as account_sub_name_to, /*交易对象*/
        account_sub_trade_type, /*交易类型*/
        account_sub_trade_no, /*流水号*/
        account_sub_trade_tran_amt, /*交易金额*/
        account_sub_trade_tran_fee, /*手续费*/
        account_sub_trade_tran_payment_type, /*转入转出*/
        account_sub_trade_tran_status, /*交易状态*/
        account_sub_trade_take_cash_account_no, /*收款账户*/
        account_sub_trade_take_cash_account_name, /*收款账户*/
        account_sub_trade_ccy, /*币种*/
        account_sub_trade_remark, /*备注*/
        d2.dict_value as business_trade_business_typeC, /*业务类型*/
        business_trade_business_no, /*业务单号*/
        business_trade_business_content,
        d1.dict_value as business_trade_business_fromC, /*来源*/
        account_type,
        account_sub_trade_back_reason

        FROM account_sub_trade
        RIGHT JOIN account_sub _from ON _from.account_sub_id = account_sub_trade.account_sub_trade_in_account_sub_id
        LEFT JOIN account ON _from.account_sub_account_id=account.account_id
        LEFT JOIN account_sub _to ON _to.account_sub_id = account_sub_trade.account_sub_trade_account_sub_id
        LEFT JOIN business_trade ON
        business_trade.business_trade_account_sub_trade_id=account_sub_trade.account_sub_trade_id
        LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务来源') d1 on d1.dict_key = business_trade_business_from
        LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务类型') d2 on d2.dict_key = business_trade_business_type

        <where>
            case
                when business_trade_id is not null then  ( business_trade_is_delete = 0 and business_trade_status != 1)
                when business_trade_id is null then ( 1=1)
            end
            and account_sub_trade_tran_status >= 0 and account_sub_trade_tran_status not in (7,9)
            <if test="startTime!=null">
                and account_sub_trade.account_sub_trade_create_time <![CDATA[ >= ]]> #{startTime}
            </if>
            <if test="endTime!=null">
                and account_sub_trade.account_sub_trade_create_time <![CDATA[ <= ]]> DATE_ADD(#{endTime},INTERVAL 1
                DAY)
            </if>
            <if test="startAmt!=null">
                and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ >= ]]> #{startAmt}
            </if>
            <if test="endAmt!=null">
                and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ <= ]]> #{endAmt}
            </if>
            <if test="tradeType != null">
                and account_sub_trade.account_sub_trade_type = #{tradeType}
            </if>
            <if test="tradeStatus != null">
                and account_sub_trade.account_sub_trade_tran_status = #{tradeStatus}
            </if>
            <if test="businessType!=null and businessType!=''">
                and business_trade_business_type=#{businessType}
            </if>
            <if test="source!=null and source!=''">
                and business_trade_business_from=#{source}
            </if>
            <if test="status!=null and status!=''">
                and account_sub_trade_tran_status=#{status}
            </if>
            <if test="accountType!=null and accountType!=''">
                and account_Type=#{accountType}
            </if>
            <if test="accountName!=null and accountName!=''">
                and POSITION(#{accountName} IN _from.account_sub_name)
            </if>
            <if test='keyword !=null and keyword !=""'>
                AND (
                POSITION(#{keyword} IN account_sub_trade_no) OR
                POSITION(#{keyword} IN business_trade_business_no) OR
                POSITION(#{keyword} IN account_sub_trade_tran_amt) OR
                POSITION(#{keyword} IN account_sub_trade_remark) OR
                POSITION(#{keyword} IN account_sub_trade_take_cash_account_no) OR
                POSITION(#{keyword} IN _from.account_sub_name) OR
                POSITION(#{keyword} IN business_trade_business_content)
                )
            </if>
        </where>
    </if>
    ) t
        order by account_sub_trade_create_time desc
    </select>




    <!--业务记录 -->
    <select id="getTradeBusinessList" resultType="map">
        SELECT * FROM (


        <!--支出 -->
        <if test="income==null or income==false">
            SELECT
            account_sub_trade_id,
            account_sub_trade_bank_no,
            business_trade_create_time,
            _from.account_sub_no, /*发起账户*/
            _to.account_sub_no as account_sub_no_to, /*目标账户*/
            business_trade_status, /*状态*/
            _to.account_sub_name, /*交易对象*/
            account_sub_trade_no, /*流水号*/
            business_trade_business_no, /*业务单号*/
            business_trade_business_content, /*内容*/
            account_sub_trade_tran_amt, /*交易金额*/
            account_sub_trade_tran_fee, /*手续费*/
            account_sub_trade_tran_payment_type, /*转入转出*/
            account_sub_trade_tran_status, /*交易状态*/
            account_sub_trade_take_cash_account_no, /*收款账户*/
            account_sub_trade_take_cash_account_name, /*收款账户*/
            account_sub_trade_ccy, /*币种*/
            account_sub_trade_remark, /*备注*/
            d2.dict_value as business_trade_business_type, /*业务类型*/
            d1.dict_value as business_trade_business_from, /*来源*/
            account_sub_trade_back_reason

            FROM business_trade
            LEFT JOIN account_sub_trade ON
            business_trade.business_trade_account_sub_trade_id=account_sub_trade.account_sub_trade_id
            LEFT JOIN account_sub _from ON _from.account_sub_id = account_sub_trade.account_sub_trade_account_sub_id
            LEFT JOIN account_sub _to ON _to.account_sub_id = account_sub_trade.account_sub_trade_in_account_sub_id
            LEFT JOIN account ON _from.account_sub_account_id=account.account_id
            LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务来源') d1 on d1.dict_key = business_trade_business_from
            LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务类型') d2 on d2.dict_key = business_trade_business_type

            <where>
                business_trade_is_delete = 0 and business_trade_status != 1
                <choose>
                    <when test="no!=null and no !=''">
                        and _from.account_sub_no=#{no}
                    </when>
                    <otherwise>
                        <if test="nos!=null and nos.size>0">
                            and _from.account_sub_no IN
                            <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
                                #{item}
                            </foreach>
                        </if>
                    </otherwise>
                </choose>

                <if test="startTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ >= ]]> #{startTime}
                </if>
                <if test="endTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ <= ]]> DATE_ADD(#{endTime},INTERVAL 1
                    DAY)
                </if>
                <if test="startAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ >= ]]> #{startAmt}
                </if>
                <if test="endAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ <= ]]> #{endAmt}
                </if>
                <if test="tradeType != null">
                    and account_sub_trade.account_sub_trade_type = #{tradeType}
                </if>
                <if test="tradeStatus != null">
                    and account_sub_trade.account_sub_trade_tran_status = #{tradeStatus}
                </if>
                <if test="accountName!=null and accountName!=''">
                    and POSITION(#{accountName} IN _to.account_sub_name)
                </if>
                <if test="businessType!=null and businessType!=''">
                    and business_trade_business_type=#{businessType}
                </if>
                <if test="source!=null and source!=''">
                    and business_trade_business_from=#{source}
                </if>
                <if test="status!=null and status!=''">
                    and business_trade_status=#{status}
                </if>
                <if test="accountType!=null and accountType!=''">
                    and account_Type=#{accountType}
                </if>
                <if test='keyword !=null and keyword !=""'>
                    AND (
                    POSITION(#{keyword} IN account_sub_trade_no) OR  <!--交易单号-->
                    POSITION(#{keyword} IN business_trade_business_no) OR  <!--订单号 -->
                    POSITION(#{keyword} IN business_trade_business_content) OR <!--订单内容 -->
                    POSITION(#{keyword} IN account_sub_trade_tran_amt) OR  <!--业务金额 -->
                    POSITION(#{keyword} IN _to.account_sub_name) <!--交易主体,交易对象-->
                    )
                </if>
            </where>
        </if>
        <if test="income==null">
            UNION ALL
        </if>
        <!--收入 -->
        <if test="income==null or income==true">

            SELECT
            account_sub_trade_id,
            account_sub_trade_bank_no,
            business_trade_create_time,
            _from.account_sub_no, /*发起账户*/
            _to.account_sub_no as account_sub_no_to, /*目标账户*/
            business_trade_status, /*状态*/
            _from.account_sub_name, /*交易对象*/
            account_sub_trade_no, /*流水号*/
            business_trade_business_no, /*业务单号*/
            business_trade_business_content, /*内容*/
            account_sub_trade_tran_amt, /*交易金额*/
            account_sub_trade_tran_fee, /*手续费*/
            account_sub_trade_tran_payment_type, /*转入转出*/
            account_sub_trade_tran_status, /*交易状态*/
            account_sub_trade_take_cash_account_no, /*收款账户*/
            account_sub_trade_take_cash_account_name, /*收款账户*/
            account_sub_trade_ccy, /*币种*/
            account_sub_trade_remark, /*备注*/
            d2.dict_value as business_trade_business_type, /*业务类型*/
            d1.dict_value as business_trade_business_from, /*来源*/
            account_sub_trade_back_reason

            FROM business_trade
            LEFT JOIN account_sub_trade ON
            business_trade.business_trade_account_sub_trade_id=account_sub_trade.account_sub_trade_id
            LEFT JOIN account_sub _from ON _from.account_sub_id = account_sub_trade.account_sub_trade_account_sub_id
            LEFT JOIN account_sub _to ON _to.account_sub_id = account_sub_trade.account_sub_trade_in_account_sub_id
            LEFT JOIN account ON _from.account_sub_account_id=account.account_id
            LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务来源') d1 on d1.dict_key = business_trade_business_from
            LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务类型') d2 on d2.dict_key = business_trade_business_type

            <where>
                business_trade_is_delete = 0 and business_trade_status != 1
                <choose>
                    <when test="no!=null and no !=''">
                        and _to.account_sub_no=#{no}
                    </when>
                    <otherwise>
                        <if test="nos!=null and nos.size>0">
                            and _to.account_sub_no IN
                            <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
                                #{item}
                            </foreach>
                        </if>
                    </otherwise>
                </choose>

                <if test="startTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ >= ]]> #{startTime}
                </if>
                <if test="endTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ <= ]]> DATE_ADD(#{endTime},INTERVAL 1
                    DAY)
                </if>
                <if test="startAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ >= ]]> #{startAmt}
                </if>
                <if test="endAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ <= ]]> #{endAmt}
                </if>
                <if test="tradeType != null">
                    and account_sub_trade.account_sub_trade_type = #{tradeType}
                </if>
                <if test="accountName!=null and accountName!=''">
                    and POSITION(#{accountName} IN _from.account_sub_name)
                </if>
                <if test="businessType!=null and businessType!=''">
                    and business_trade_business_type=#{businessType}
                </if>
                <if test="tradeStatus != null">
                    and account_sub_trade.account_sub_trade_tran_status = #{tradeStatus}
                </if>
                <if test="source!=null and source!=''">
                    and business_trade_business_from=#{source}
                </if>
                <if test="status!=null and status!=''">
                    and business_trade_status=#{status}
                </if>
                <if test="accountType!=null and accountType!=''">
                    and account_Type=#{accountType}
                </if>
                <if test='keyword !=null and keyword !=""'>
                    AND (
                    POSITION(#{keyword} IN account_sub_trade_no) OR <!--交易单号 -->
                    POSITION(#{keyword} IN business_trade_business_no) OR  <!--订单号 -->
                    POSITION(#{keyword} IN business_trade_business_content) OR <!--订单内容 -->
                    POSITION(#{keyword} IN account_sub_trade_tran_amt) OR <!--业务金额 -->
                    POSITION(#{keyword} IN _to.account_sub_name) <!--交易主体,交易对象-->
                    )
                </if>
            </where>
        </if>
        ) t
        order by business_trade_create_time desc
    </select>

    <!--业务记录 后台 -->
    <select id="getTradeBusinessListAdmin" resultType="map">
        SELECT * FROM (


        <!--支出 -->
        <if test="income==null or income==false">
            SELECT
            account_sub_trade_id,
            account_sub_trade_bank_no,
            business_trade_create_time,
            _from.account_sub_no, /*发起账户*/
            _from.account_sub_name, /*子账户名称*/
            _to.account_sub_no as account_sub_no_to, /*交易对象*/
            case when _to.account_sub_name is NULL then business_trade_object ELSE _to.account_sub_name end
            as account_sub_name_to, /*交易对象*/
            account_sub_trade_no, /*流水号*/
            business_trade_status, /*状态*/
            business_trade_business_no, /*业务单号*/
            business_trade_business_content, /*内容*/
            CASE
            WHEN (account_sub_trade.account_sub_trade_in_account_sub_id  is not null and account_sub_trade.account_sub_trade_in_account_sub_id  != '') THEN
            concat( '-', account_sub_trade_tran_amt )
            else account_sub_trade_tran_amt
            END AS account_sub_trade_tran_amt ,/*交易金额*/
            account_sub_trade_tran_fee, /*手续费*/
            account_sub_trade_tran_payment_type, /*转入转出*/
            account_sub_trade_tran_status, /*交易状态*/
            account_sub_trade_take_cash_account_no, /*收款账户*/
            account_sub_trade_take_cash_account_name, /*收款账户*/
            account_sub_trade_ccy, /*币种*/
            account_sub_trade_remark, /*备注*/
            d2.dict_value as business_trade_business_typeC, /*业务类型*/
            d1.dict_value as business_trade_business_fromC, /*来源*/
            account_sub_trade_back_reason

            FROM business_trade
            LEFT JOIN account_sub_trade ON
            business_trade.business_trade_account_sub_trade_id=account_sub_trade.account_sub_trade_id
            LEFT JOIN account_sub _from ON _from.account_sub_id = account_sub_trade.account_sub_trade_account_sub_id
            LEFT JOIN account_sub _to ON _to.account_sub_id = account_sub_trade.account_sub_trade_in_account_sub_id
            LEFT JOIN account ON _from.account_sub_account_id=account.account_id
            LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务来源') d1 on d1.dict_key = business_trade_business_from
            LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务类型') d2 on d2.dict_key = business_trade_business_type

            <where>
                business_trade_is_delete = 0 and business_trade_status != 1 and  account_sub_trade_account_sub_id is not null and account_sub_trade_account_sub_id != ''
                <if test="startTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ >= ]]> #{startTime}
                </if>
                <if test="endTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ <= ]]> DATE_ADD(#{endTime},INTERVAL 1
                    DAY)
                </if>
                <if test="startAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ >= ]]> #{startAmt}
                </if>
                <if test="endAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ <= ]]> #{endAmt}
                </if>
                <if test="tradeType != null">
                    and account_sub_trade.account_sub_trade_type = #{tradeType}
                </if>
                <if test="tradeStatus != null">
                    and account_sub_trade.account_sub_trade_tran_status = #{tradeStatus}
                </if>
                <if test="accountName!=null and accountName!=''">
                    and POSITION(#{accountName} IN _to.account_sub_name)
                </if>
                <if test="businessType!=null and businessType!=''">
                    and business_trade_business_type=#{businessType}
                </if>
                <if test="source!=null and source!=''">
                    and business_trade_business_from=#{source}
                </if>
                <if test="status!=null and status!=''">
                    and business_trade_status=#{status}
                </if>
                <if test="accountType!=null and accountType!=''">
                    and account_Type=#{accountType}
                </if>
                <if test='keyword !=null and keyword !=""'>
                    AND (
                    POSITION(#{keyword} IN account_sub_trade_no) OR  <!--交易单号-->
                    POSITION(#{keyword} IN business_trade_business_no) OR  <!--订单号 -->
                    POSITION(#{keyword} IN business_trade_business_content) OR <!--订单内容 -->
                    POSITION(#{keyword} IN account_sub_trade_tran_amt) OR  <!--业务金额 -->
                    POSITION(#{keyword} IN _to.account_sub_name) <!--交易主体,交易对象-->
                    )
                </if>
            </where>
        </if>
        <if test="income==null">
            UNION ALL
        </if>
        <!--收入 -->
        <if test="income==null or income==true">

            SELECT
            account_sub_trade_id,
            account_sub_trade_bank_no,
            business_trade_create_time,
            _from.account_sub_no, /*账户编号*/
            _from.account_sub_name, /*子账户名称*/
            _to.account_sub_no as account_sub_no_to, /*交易对象*/
            case when _to.account_sub_name is NULL then business_trade_object ELSE _to.account_sub_name end
            as account_sub_name_to,/*交易对象*/
            account_sub_trade_no, /*流水号*/
            business_trade_status, /*状态*/
            business_trade_business_no, /*业务单号*/
            business_trade_business_content, /*内容*/
            account_sub_trade_tran_amt, /*交易金额*/
            account_sub_trade_tran_fee, /*手续费*/
            '2' as account_sub_trade_tran_payment_type, /*转入转出*/
            account_sub_trade_tran_status, /*交易状态*/
            account_sub_trade_take_cash_account_no, /*收款账户*/
            account_sub_trade_take_cash_account_name, /*收款账户*/
            account_sub_trade_ccy, /*币种*/
            account_sub_trade_remark, /*备注*/
            d2.dict_value as business_trade_business_typeC, /*业务类型  */
            d1.dict_value as business_trade_business_fromC, /*来源*/
            account_sub_trade_back_reason


            FROM business_trade
            LEFT JOIN account_sub_trade ON
            business_trade.business_trade_account_sub_trade_id=account_sub_trade.account_sub_trade_id
            LEFT JOIN account_sub _from ON _from.account_sub_id = account_sub_trade.account_sub_trade_in_account_sub_id
            LEFT JOIN account_sub _to ON _to.account_sub_id = account_sub_trade.account_sub_trade_account_sub_id
            LEFT JOIN account ON _from.account_sub_account_id=account.account_id
            LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务来源') d1 on d1.dict_key = business_trade_business_from
            LEFT JOIN (select dict_key,dict_value from dict where dict_type = '业务类型') d2 on d2.dict_key = business_trade_business_type
            <where>
                business_trade_is_delete = 0 and business_trade_status != 1
                <if test="startTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ >= ]]> #{startTime}
                </if>
                <if test="endTime!=null">
                    and account_sub_trade.account_sub_trade_create_time <![CDATA[ <= ]]> DATE_ADD(#{endTime},INTERVAL 1
                    DAY)
                </if>
                <if test="startAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ >= ]]> #{startAmt}
                </if>
                <if test="endAmt!=null">
                    and account_sub_trade.account_sub_trade_tran_amt <![CDATA[ <= ]]> #{endAmt}
                </if>
                <if test="tradeType != null">
                    and account_sub_trade.account_sub_trade_type = #{tradeType}
                </if>
                <if test="accountName!=null and accountName!=''">
                    and POSITION(#{accountName} IN _from.account_sub_name)
                </if>
                <if test="businessType!=null and businessType!=''">
                    and business_trade_business_type=#{businessType}
                </if>
                <if test="tradeStatus != null">
                    and account_sub_trade.account_sub_trade_tran_status = #{tradeStatus}
                </if>
                <if test="source!=null and source!=''">
                    and business_trade_business_from=#{source}
                </if>
                <if test="status!=null and status!=''">
                    and business_trade_status=#{status}
                </if>
                <if test="accountType!=null and accountType!=''">
                    and account_Type=#{accountType}
                </if>
                <if test='keyword !=null and keyword !=""'>
                    AND (
                    POSITION(#{keyword} IN account_sub_trade_no) OR <!--交易单号 -->
                    POSITION(#{keyword} IN business_trade_business_no) OR  <!--订单号 -->
                    POSITION(#{keyword} IN business_trade_business_content) OR <!--订单内容 -->
                    POSITION(#{keyword} IN account_sub_trade_tran_amt) OR <!--业务金额 -->
                    POSITION(#{keyword} IN _to.account_sub_name) <!--交易主体,交易对象-->
                    )
                </if>
            </where>
        </if>
        ) t
        order by business_trade_create_time desc
    </select>


    <select id="getInHandTrade" resultType="com.test.manage.model.dto.InHandTradeDto">
        SELECT
            account_sub_trade_id,
            account_sub_trade_bank_no,
            account_sub_trade_type,
            account_sub_no,
            account_fund_summary_account_no
        FROM account_sub_trade
        LEFT JOIN account_sub ON account_sub_id = account_sub_trade_account_sub_id
        LEFT JOIN account ON account_id = account_sub_account_id
        WHERE account_sub_trade_tran_status = 6
          AND account_sub_trade_type = 4
    </select>
    <!--日支出 -->
    <select id="dayPay" resultType="map">
        select
        IFNULL(sum(account_sub_trade_tran_amt), 0) as dayPay
        FROM account_sub_trade
        INNER JOIN account_sub ON account_sub_trade.account_sub_trade_account_sub_id=account_sub.account_sub_id
        WHERE DATEDIFF(account_sub_trade.account_sub_trade_create_time,NOW())=0
        AND account_sub_trade_tran_status = 0
        AND account_sub.account_sub_no IN
        <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <!--日收入 -->
    <select id="dayIncome" resultType="map">
        select
        IFNULL(sum(account_sub_trade_tran_amt - account_sub_trade_tran_fee), 0) as dayIncome
        FROM account_sub_trade
        INNER JOIN account_sub ON account_sub_trade.account_sub_trade_in_account_sub_id=account_sub.account_sub_id
        WHERE DATEDIFF(account_sub_trade.account_sub_trade_create_time,NOW())=0
        AND account_sub_trade_tran_status = 0
        AND account_sub.account_sub_no IN
        <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <!--本月支出 -->
    <select id="monthPay" resultType="map">
        select
        IFNULL(sum(account_sub_trade_tran_amt), 0) as monthPay
        FROM account_sub_trade
        INNER JOIN account_sub ON account_sub_trade.account_sub_trade_account_sub_id=account_sub.account_sub_id
        WHERE DATE_FORMAT(account_sub_trade.account_sub_trade_create_time, '%Y%m') = DATE_FORMAT( CURDATE( ) , '%Y%m' )
        AND account_sub_trade_tran_status = 0
        AND account_sub.account_sub_no IN
        <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <!--本月收入 -->
    <select id="monthIncome" resultType="map">
        select
        IFNULL(sum(account_sub_trade_tran_amt - account_sub_trade_tran_fee), 0) as monthIncome
        FROM account_sub_trade
        INNER JOIN account_sub ON account_sub_trade.account_sub_trade_in_account_sub_id=account_sub.account_sub_id
        WHERE DATE_FORMAT(account_sub_trade.account_sub_trade_create_time, '%Y%m') = DATE_FORMAT( CURDATE( ) , '%Y%m' )
        AND account_sub_trade_tran_status = 0
        AND account_sub.account_sub_no IN
        <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <delete id="deleteInvalidDate">
        DELETE FROM account_sub_trade
        WHERE account_sub_trade_tran_status= -1
        AND account_sub_trade_create_time &lt; DATE_ADD(curdate(),INTERVAL 18 hour)
    </delete>

    <select id="getServiceChargeList" parameterType="com.test.manage.model.form.ServiceChargeForm"
            resultType="com.test.manage.model.dto.AccountSubTradeDto">
        SELECT
        ast.account_sub_trade_id,
        ast.account_sub_trade_tran_date,
        ast.account_sub_trade_no,
        ast.account_sub_trade_tran_amt,
        ast.account_sub_trade_tran_fee,
        CONCAT( ROUND ( ( ast.account_sub_trade_tran_fee / ast.account_sub_trade_tran_amt ) * 100, 2 ), "%" ) as
        percentage,
        ast.account_sub_trade_type,
        asu.account_sub_name,
        asu.account_sub_no,
        ast.account_sub_trade_tran_status
        FROM
        account_sub_trade ast
        LEFT JOIN account_sub asu ON ast.account_sub_trade_account_sub_id = asu.account_sub_id
        WHERE
        ast.account_sub_trade_type IN ( 1, 2, 3, 4 )
        AND ast.account_sub_trade_tran_status = 0
        AND ast.account_sub_trade_tran_fee > 0
        <if test="relationId != null and relationId != ''">
            AND asu.account_sub_id = #{relationId}
        </if>
        <if test="type != null">
            AND ast.account_sub_trade_type = #{type}
        </if>
        <if test="startTime != null">
            AND ast.account_sub_trade_tran_date <![CDATA[ >= ]]> #{startTime}
        </if>
        <if test="endTime != null">
            AND ast.account_sub_trade_tran_date <![CDATA[ <= ]]> DATE_ADD(#{endTime}, INTERVAL 1 DAY)
        </if>
        <if test="keyword != null and keyword !='' ">
            AND (
            POSITION(#{keyword} IN ast.account_sub_trade_no ) OR
            POSITION(#{keyword} IN ast.account_sub_trade_tran_amt) OR
            POSITION(#{keyword} IN ast.account_sub_trade_tran_fee ) OR
            POSITION(#{keyword} IN asu.account_sub_name) OR
            POSITION(#{keyword} IN asu.account_sub_no)
            )
        </if>
        ORDER BY
        ast.account_sub_trade_create_time DESC
    </select>


    <select id="getServiceChargeAccountName" resultType="java.util.Map">
        SELECT
        DISTINCT
        accountSubId ,
        accountSubName
        from (
          select
            asu.account_sub_id AS accountSubId,
            asu.account_sub_name AS accountSubName
        FROM
            account_sub_trade ast
        RIGHT JOIN account_sub asu ON ast.account_sub_trade_account_sub_id = asu.account_sub_id
              WHERE
            ast.account_sub_trade_type IN ( 1, 2, 3, 4 )
            AND ast.account_sub_trade_tran_status = 0
            AND ast.account_sub_trade_tran_fee > 0
            ORDER BY
            ast.account_sub_trade_create_time DESC
        ) temp

    </select>

    <!--总账户日支出 流水类型，1-会员交易，2-转账，3-充值，4-提现，5-服务费，6-退款，7-挂账-->
    <select id="totalAccountDayPay" resultType="map">
        select
        IFNULL(sum(account_sub_trade_tran_amt), 0) as dayPay
        FROM account_sub_trade
        INNER JOIN account_sub ON account_sub_trade.account_sub_trade_account_sub_id=account_sub.account_sub_id
        WHERE DATEDIFF(account_sub_trade.account_sub_trade_create_time,NOW())=0
        AND account_sub_trade_tran_status = 0 AND account_sub_trade.account_sub_trade_type = 4
        AND account_sub.account_sub_no IN
        <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <!--总账户日收入 -->
    <select id="totalAccountDayIncome" resultType="map">
        select
        IFNULL(sum(account_sub_trade_tran_amt - account_sub_trade_tran_fee), 0) as dayIncome
        FROM account_sub_trade
        INNER JOIN account_sub ON account_sub_trade.account_sub_trade_in_account_sub_id=account_sub.account_sub_id
        WHERE DATEDIFF(account_sub_trade.account_sub_trade_create_time,NOW())=0
        AND account_sub_trade_tran_status = 0 AND ((account_sub_trade.account_sub_trade_type = 3) OR (account_sub_trade.account_sub_trade_type = 7))
        AND account_sub.account_sub_no IN
        <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <!--总账户本月支出 -->
    <select id="totalAccountMonthPay" resultType="map">
        select
        IFNULL(sum(account_sub_trade_tran_amt), 0) as monthPay
        FROM account_sub_trade
        INNER JOIN account_sub ON account_sub_trade.account_sub_trade_account_sub_id=account_sub.account_sub_id
        WHERE DATE_FORMAT(account_sub_trade.account_sub_trade_create_time, '%Y%m') = DATE_FORMAT( CURDATE( ) , '%Y%m' )
        AND account_sub_trade_tran_status = 0 AND account_sub_trade.account_sub_trade_type = 4
        AND account_sub.account_sub_no IN
        <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <!--总账户本月收入 -->
    <select id="totalAccountMonthIncome" resultType="map">
        select
        IFNULL(sum(account_sub_trade_tran_amt - account_sub_trade_tran_fee), 0) as monthIncome
        FROM account_sub_trade
        INNER JOIN account_sub ON account_sub_trade.account_sub_trade_in_account_sub_id=account_sub.account_sub_id
        WHERE DATE_FORMAT(account_sub_trade.account_sub_trade_create_time, '%Y%m') = DATE_FORMAT( CURDATE( ) , '%Y%m' )
        AND account_sub_trade_tran_status = 0 AND ((account_sub_trade.account_sub_trade_type = 3) OR (account_sub_trade.account_sub_trade_type = 7))
        AND account_sub.account_sub_no IN
        <foreach item="item" index="index" collection="nos" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <select id="getUnfinishedTrade" resultType="com.test.manage.model.generator.AccountSubTrade">
        select * from account_sub_trade
        where (account_sub_trade_type = 3 or(account_sub_trade_type = 1 and account_is_deal = 0))
        and account_sub_trade_tran_status = 6
    </select>
</mapper>